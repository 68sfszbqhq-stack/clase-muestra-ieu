<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Alto Rendimiento</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/lms_theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>

<body class="lms-body">

    <!-- SIDEBAR -->
    <nav class="lms-sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-dumbbell fa-2x" style="color:var(--lms-primary)"></i>
            <span style="font-weight:bold; font-size:1.2rem; color:white;">IEU Sport</span>
        </div>

        <ul class="nav-links">
            <li class="active" onclick="switchTab('home')"><i class="fa-solid fa-map"></i> Mapa del Curso</li>
            <li onclick="switchTab('community')"><i class="fa-solid fa-users"></i> Comunidad</li>
            <li onclick="switchTab('lab')"><i class="fa-solid fa-flask"></i> Laboratorio</li>
            <li onclick="switchTab('profile')"><i class="fa-solid fa-id-card"></i> Mi Ficha T√©cnica</li>
        </ul>

        <button class="logout-btn" onclick="logout()"><i class="fa-solid fa-sign-out"></i> Cerrar Sesi√≥n</button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="lms-main">

        <!-- TOP BAR -->
        <header class="lms-header">
            <div>
                <h2 id="user-greeting">Hola, Entrenador üëã</h2>
                <p style="color:#777; font-size:0.9rem;">Contin√∫a tu preparaci√≥n hacia el oro.</p>
            </div>

            <div class="xp-container">
                <div style="font-size:0.8rem; font-weight:bold; margin-bottom:5px;">NIVEL <span id="user-level">1</span>
                </div>
                <div class="xp-bar-bg">
                    <div id="user-xp-bar" class="xp-bar-fill" style="width: 0%"></div>
                </div>
                <div style="font-size:0.7rem; text-align:right; margin-top:2px;"><span id="user-xp">0</span> XP</div>
            </div>
        </header>

        <!-- 1. VISTA MAPA (HOME) -->
        <div id="view-home" class="view-section active">
            <h3 class="section-title">Tu Ruta de Aprendizaje</h3>
            <div class="modules-grid-lms">
                <!-- UNIDAD 1 -->
                <div class="lms-module-card unlock" onclick="openModule('periodizacion')">
                    <div class="module-status"><i class="fa-solid fa-check-circle"></i> En Progreso</div>
                    <div class="module-icon"><i class="fa-solid fa-layer-group"></i></div>
                    <h3>Unidad 1: Modelos de Periodizaci√≥n</h3>
                    <p>Matveev, Pendular, Bloques y ATR. Construye los cimientos.</p>
                    <div class="progress-mini">
                        <div class="bar" style="width: 40%"></div>
                    </div>
                </div>
                <!-- UNIDAD 2 -->
                <div class="lms-module-card lock">
                    <div class="module-status"><i class="fa-solid fa-lock"></i> Bloqueado</div>
                    <div class="module-icon"><i class="fa-solid fa-heart-pulse"></i></div>
                    <h3>Unidad 2: Fisiolog√≠a de Carga</h3>
                    <p>Umbrales, Lactato y Adaptaci√≥n. El motor del atleta.</p>
                </div>
                <!-- UNIDAD 3 -->
                <div class="lms-module-card lock">
                    <div class="module-icon"><i class="fa-solid fa-weight-hanging"></i></div>
                    <h3>Unidad 3: Desarrollo de Fuerza</h3>
                    <p>Hipertrofia, Potencia y Fuerza M√°xima.</p>
                </div>
            </div>
        </div>

        <!-- 2. VISTA DETALLE M√ìDULO -->
        <div id="view-module" class="view-section">
            <button class="btn-back" onclick="switchTab('home')"><i class="fa-solid fa-arrow-left"></i> Volver al
                Mapa</button>
            <div class="module-header-banner">
                <h1 id="mod-title">Unidad 1: Periodizaci√≥n</h1>
                <div class="mod-tabs">
                    <button class="tab-btn active" onclick="modTab('content')"><i class="fa-solid fa-book-open"></i>
                        Contenido</button>
                    <button class="tab-btn" onclick="modTab('challenge')"><i class="fa-solid fa-puzzle-piece"></i>
                        Desaf√≠o</button>
                    <button class="tab-btn" onclick="modTab('exam')"><i class="fa-solid fa-trophy"></i>
                        Evaluaci√≥n</button>
                </div>
            </div>

            <!-- Tabs Internos -->
            <div id="tab-content" class="mod-tab-content active">
                <div class="content-wrapper">
                    <div class="video-placeholder">
                        <i class="fa-solid fa-play-circle fa-3x"></i>
                        <p>Video Introductorio: ¬øPor qu√© fallan los planes?</p>
                    </div>
                    <div class="slides-integration-box">
                        <h4><i class="fa-solid fa-presentation-screen"></i> Clase Interactiva</h4>
                        <p>Explora los conceptos clave de forma visual.</p>
                        <a href="presentation/slides.html" target="_blank" class="btn-launch">Abrir Presentaci√≥n</a>
                    </div>
                </div>
            </div>

            <div id="tab-challenge" class="mod-tab-content">
                <h3>El Caso del Maratonista Frustrado</h3>
                <p>Analiza el siguiente caso parad√≥jico y prop√≥n una soluci√≥n.</p>
            </div>

            <div id="tab-exam" class="mod-tab-content">
                <div class="exam-card-center"
                    style="text-align:center; padding:40px; background:white; border-radius:15px;">
                    <h3>Quiz de Certificaci√≥n: Unidad 1</h3>
                    <a href="presentation/exam.html" target="_blank" class="btn-launch-exam">Iniciar Examen</a>
                </div>
            </div>
        </div>

        <!-- 3. VISTA LABORATORIO (Iframe Integrado) -->
        <div id="view-lab" class="view-section" style="height: 100%;">
            <!-- src vac√≠o para lazy load -->
            <iframe id="lab-frame" style="width:100%; height:80vh; border:none; border-radius:15px;"></iframe>
        </div>

        <!-- 4. VISTA COMUNIDAD (Foros) -->
        <div id="view-community" class="view-section">
            <h3 class="section-title">Vestidor del Equipo (Foro)</h3>
            <div class="forum-container">
                <div class="forum-sidebar">
                    <button class="btn-new-topic"><i class="fa-solid fa-plus"></i> Nuevo Tema</button>
                    <ul class="topic-list">
                        <li class="active">
                            <span class="topic-tag tag-general">General</span>
                            <div class="topic-info">
                                <strong>Dudas sobre Matveev</strong>
                                <small>hace 2 horas ‚Ä¢ 5 respuestas</small>
                            </div>
                        </li>
                        <li>
                            <span class="topic-tag tag-debate">Debate</span>
                            <div class="topic-info">
                                <strong>¬øATR en infantiles?</strong>
                                <small>ayer ‚Ä¢ 12 respuestas</small>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="forum-chat-area">
                    <!-- √Årea de Mensajes Din√°mica -->
                    <div id="chat-feed" class="chat-feed">
                        <!-- Los mensajes se cargar√°n aqu√≠ v√≠a JS -->
                        <div class="chat-msg system">
                            <small>Bienvenido al canal <strong>#General</strong>. S√© respetuoso.</small>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="chat-input-area">
                        <input type="text" id="msg-input" placeholder="Escribe tu aporte..."
                            onkeypress="handleEnter(event)">
                        <button onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. VISTA PERFIL (Portafolio) -->
        <div id="view-profile" class="view-section">
            <div class="profile-grid">
                <div class="profile-card info">
                    <div class="profile-avatar-lg">JM</div>
                    <h2 id="profile-name">Jose Mendoza</h2>
                    <p class="role-badge">Entrenador Titular</p>
                    <div class="stats-row">
                        <div><strong>5</strong><br>M√≥dulos</div>
                        <div><strong>1250</strong><br>XP</div>
                        <div><strong>Rank 3</strong><br>Global</div>
                    </div>
                </div>
                <div class="profile-card medals">
                    <h3>üèÜ Medallero</h3>
                    <div class="medals-grid">
                        <div class="medal unlocked" title="Primeros Pasos"><i class="fa-solid fa-shoe-prints"></i></div>
                        <div class="medal unlocked" title="Te√≥rico"><i class="fa-solid fa-book"></i></div>
                        <div class="medal locked" title="Maestro Planificador"><i class="fa-solid fa-chess"></i></div>
                        <div class="medal locked" title="Gur√∫ del Foro"><i class="fa-solid fa-comment-dots"></i></div>
                    </div>
                </div>
                <div class="profile-card journal">
                    <h3>üìí Diario de Aprendizaje</h3>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">Reflexiona: ¬øQu√© aprendiste hoy?</p>
                    <textarea id="journal-input" class="journal-input"
                        placeholder="Hoy descubr√≠ que la periodizaci√≥n inversa es √∫til para..."></textarea>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <button class="btn-primary-lms" style="padding:8px 15px;" onclick="saveJournalEntry()">Guardar
                            Entrada</button>
                        <span id="journal-feedback" style="font-size:0.8rem; color:#4CAF50; display:none;"><i
                                class="fa-solid fa-check"></i> Guardado (+10 XP)</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script src="js/firebase-config.js"></script>
    <script src="js/lms_core.js"></script>
    <script src="js/lms_forum.js"></script>
    <script src="js/lms_journal.js"></script>
    <script>
        // UI Logic
        function switchTab(tabId) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            // Mostrar la seleccionada
            const target = document.getElementById('view-' + tabId);
            if (target) target.classList.add('active');

            // Actualizar Sidebar Active State
            document.querySelectorAll('.nav-links li').forEach(el => el.classList.remove('active'));

            if (tabId === 'home') document.querySelector('.nav-links li:nth-child(1)').classList.add('active');
            if (tabId === 'community') document.querySelector('.nav-links li:nth-child(2)').classList.add('active');
            if (tabId === 'lab') {
                document.querySelector('.nav-links li:nth-child(3)').classList.add('active');
                // Lazy Load del Lab
                const frame = document.getElementById('lab-frame');
                if (!frame.getAttribute('src')) frame.src = "lab_macrocycle.html";
            }
            if (tabId === 'profile') document.querySelector('.nav-links li:nth-child(4)').classList.add('active');
        }

        function openModule(modId) {
            document.getElementById('view-home').classList.remove('active');
            document.getElementById('view-module').classList.add('active');
            // Cargar datos din√°micos si fuera necesario
        }

        function modTab(tabName) {
            document.querySelectorAll('.mod-tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // Init Check
        window.onload = function () {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('user-greeting').textContent = "Hola, " + (user.displayName || "Entrenador");
                    if (document.getElementById('profile-name')) document.getElementById('profile-name').textContent = user.displayName;
                } else {
                    let guest = JSON.parse(localStorage.getItem('lms_guest_user'));
                    if (guest) {
                        document.getElementById('user-greeting').textContent = "Hola, " + guest.displayName;
                        if (document.getElementById('profile-name')) document.getElementById('profile-name').textContent = guest.displayName;
                    } else {
                        window.location.href = 'lms_index.html';
                    }
                }
            });
        };

        function logout() {
            firebase.auth().signOut();
            localStorage.removeItem('lms_guest_user');
            window.location.href = 'lms_index.html';
        }
    </script>
</body>

</html>